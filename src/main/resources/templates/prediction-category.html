<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Прогнозирование потребностей по фармакологической группе</title>
  <link rel="stylesheet" type="text/css" href="/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
<nav>
  <div class="nav-left">
    <span th:text="'Здравствуйте, ' + ${username} + '!'"></span>
  </div>
  <div class="nav-right">
    <a href="/logout">
      <button>Выйти</button>
    </a>
  </div>
</nav>

<h1 style="text-align: center;">Прогнозирование потребностей по фармакологической группе</h1>

<div class="add-form-form" id="form">
  <div class="left-section">
    <label for="category-id">Выберите фармакологическую группу, для которого нужно произвести прогнозирование:</label><br>
    <select id="category-id">
      <option th:each="category : ${categories}" th:value="${category.id}" th:utext="${category.name}"></option>
    </select><br><br>
  </div>
  <div class="right-section">
    <label for="weeks-number">За последние N недель:</label><br>
    <input type="number" id="weeks-number" name="weeks-number" min="1" max="100" step="1" value="10"><br><br>
  </div>
</div>

<div style="margin-top: 60px;"></div>

<div class="add-form">
  <p>Прогноз расхода препаратов фармакологической группы на следующую неделю: <span id="nextWeekOutflowPrediction"></span> штук</p>
  <p>Прогноз расхода препаратов фармакологической группы на следующий месяц: <span id="nextMonthOutflowPrediction"></span> штук</p>
  <br><br><br>
  <div id="chart-container">
    <canvas id="outflow-chart"></canvas>
  </div>
</div>

<div style="text-align: center;">
  <a href="/home" class="home-button">Домой</a>
</div>

<div style="text-align: center; margin-top: 20px;">
  <button id="download-pdf">Скачать отчёт</button>
</div>

<script>
  var myChart;

  function getPredictionData() {
      var productId = document.getElementById("category-id").value;
      var weeksNumber = document.getElementById("weeks-number").value;
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
          if (xhr.readyState === XMLHttpRequest.DONE) {
              if (xhr.status === 200) {
                  var response = JSON.parse(xhr.responseText);
                  document.getElementById('nextWeekOutflowPrediction').textContent = response.nextWeekOutflowPrediction.toFixed(2);
                  document.getElementById('nextMonthOutflowPrediction').textContent = response.nextMonthOutflowPrediction.toFixed(2);

                  if (window.myChart) {
                      myChart.destroy();
                  }

                  var ctx = document.getElementById('outflow-chart').getContext('2d');

                  // Создаем массив с данными для каждой линии
                  var datasets = response.productNames.map((productName, index) => {
                      return {
                          label: productName,
                          data: response.outflowValuesLists[index],
                          borderColor: getRandomColor(),
                          tension: 0.1
                      };
                  });

                  window.myChart = new Chart(ctx, {
                      type: 'line',
                      data: {
                          labels: response.labels,
                          datasets: datasets
                      },
                      options: {
                          scales: {
                              y: {
                                  beginAtZero: true
                              }
                          },
                          plugins: {
                              title: {
                                  display: true,
                                  text: 'График с каждым случаем расхода препаратов фармакологической группы за последние ' + weeksNumber + ' недель',
                                  position: 'bottom'
                              }
                          }
                      }
                  });

              } else {
                  console.error('Ошибка при выполнении запроса:', xhr.status);
              }
          }
      };
      xhr.open('GET', '/prediction-category/' + productId + '-' + weeksNumber);
      xhr.send();
  }

  function getRandomColor() {
      var letters = '0123456789ABCDEF';
      var color = '#';
      for (var i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
  }


  document.addEventListener("DOMContentLoaded", function() {
    getPredictionData();
  });


  document.getElementById('category-id').addEventListener('change', function() {
    getPredictionData();
  });

  document.getElementById('weeks-number').addEventListener('change', function() {
    getPredictionData();
  });

  document.getElementById('download-pdf').addEventListener('click', function() {
    const { jsPDF } = window.jspdf;
    const content = document.getElementById('chart-container');
    const canvas = document.getElementById('outflow-chart');
    const nav = document.querySelector('nav');
    const h1 = document.querySelector('h1');
    const homeButton = document.querySelector('.home-button');
    const downloadButton = document.getElementById('download-pdf');
    const form = document.getElementById('form');
    const selectedCategoryId = document.getElementById('category-id').value;

    // Скрываем лишнее
    nav.style.display = 'none';
    homeButton.style.display = 'none';
    downloadButton.style.display = 'none';
    form.style.display = 'none';

    // Получаем название выбранного препарата
    const selectedCategory = document.querySelector('#category-id option:checked').textContent;

    // Заменяем подпись отчёта
    h1.innerHTML = `Отчётность по прогнозированию потребностей в фармакологической группе "${selectedCategory}"`;

    // Увеличиваем график на всю страницу
    const originalWidth = canvas.style.width;
    const originalHeight = canvas.style.height;
    content.style.width = '100%';
    content.style.height = '100vh';
    canvas.style.width = '100%';
    canvas.style.height = '100vh';
    myChart.resize();

    // Отключаем стили background-color и border
    const addFormElements = document.querySelectorAll('.add-form');
    const originalStyles = [];
    addFormElements.forEach(element => {
        originalStyles.push({
            backgroundColor: element.style.backgroundColor,
            border: element.style.border
        });
        element.style.backgroundColor = 'none';
        element.style.border = 'none';
    });

    // Захват содержимого страницы
    html2canvas(document.body).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save('report.pdf');

        // Возвращаем оригинальную подпись
        h1.innerHTML = `Прогнозирование потребностей по фармакологической группе`;

        // Возвращаем скрытые элементы
        nav.style.display = '';
        homeButton.style.display = '';
        downloadButton.style.display = '';
        form.style.display = '';

        // Возвращаем исходные размеры графика
        content.style.width = '';
        content.style.height = '';
        canvas.style.width = originalWidth;
        canvas.style.height = originalHeight;
        myChart.resize();

        // Восстанавливаем стили background-color и border
        addFormElements.forEach((element, index) => {
            element.style.backgroundColor = originalStyles[index].backgroundColor;
            element.style.border = originalStyles[index].border;
        });
    });
  });
</script>
</body>
</html>